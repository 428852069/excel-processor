<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿è¡¨æ ¼è‡ªåŠ¨åŒ–å¤„ç†ä¸­å¿ƒ</title>
    <!-- 1. å¼•å…¥ Handsontable çš„æ ·å¼æ–‡ä»¶ -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { margin: 20px; background-color: #f5f7fa; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); padding: 25px; }
        header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        header h1 { color: #2c3e50; margin-bottom: 5px; }
        header p { color: #7f8c8d; font-size: 1.1em; }

        /* åŠŸèƒ½åŒºæ ·å¼ */
        .control-panel { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 6px; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #545b62; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #d39e00; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #bd2130; }
        .file-input-wrapper { flex-grow: 1; }
        .file-input-wrapper input[type="file"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; }

        /* å·¥å…·æ æ ·å¼ */
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: #e9ecef; border-radius: 6px; }
        .toolbar-label { font-weight: bold; color: #495057; margin-right: 10px; align-self: center; }

        /* è¡¨æ ¼ç¼–è¾‘åŒºæ ·å¼ */
        #excelEditorContainer { height: 500px; margin-bottom: 20px; border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden; }
        .hot { /* Handsontable è¡¨æ ¼æ ·å¼ */ }

        /* æäº¤ä¸ä¸‹è½½åŒº */
        .submit-area { text-align: center; padding-top: 20px; border-top: 1px solid #eee; }
        .instructions { background-color: #e7f3ff; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 4px solid #007bff; }
        .instructions p { margin: 5px 0; font-size: 0.95em; }
        
        /* çŠ¶æ€æç¤º */
        .status { padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 0.9em; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š åœ¨çº¿è¡¨æ ¼è‡ªåŠ¨åŒ–å¤„ç†ä¸­å¿ƒ</h1>
            <p>ä¸Šä¼ Excelæ–‡ä»¶ï¼Œä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·å¤„ç†ï¼Œç¼–è¾‘åä¸€é”®æäº¤</p>
        </header>

        <!-- çŠ¶æ€æç¤ºåŒºåŸŸ -->
        <div id="statusArea"></div>

        <!-- 1. ä¸Šä¼ æ–‡ä»¶åŒº -->
        <div class="control-panel">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            </div>
            <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary">ğŸ“ é€‰æ‹©Excelæ–‡ä»¶</button>
            <button onclick="saveFile()" class="btn btn-success">ğŸ’¾ ä¸‹è½½å½“å‰è¡¨æ ¼</button>
            <button onclick="clearData()" class="btn btn-danger">ğŸ—‘ï¸ æ¸…ç©ºè¡¨æ ¼</button>
        </div>

        <!-- 2. å·¥å…·æ ï¼ˆå››ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬æŒ‰é’®ï¼‰ -->
        <div class="toolbar">
            <div class="toolbar-label">ğŸ”§ è‡ªåŠ¨åŒ–å·¥å…·ï¼š</div>
            <button onclick="checkAge()" class="btn btn-warning">æ£€éªŒæ˜¯å¦æ»¡14å‘¨å²</button>
            <button onclick="markLeague()" class="btn btn-warning">è‡ªåŠ¨æ ‡è®°æ˜¯å¦å…¥å›¢</button>
            <button onclick="markGraduation()" class="btn btn-warning">è‡ªåŠ¨æ ‡è®°æ˜¯å¦æ¯•ä¸š</button>
            <button onclick="checkActivity()" class="btn btn-warning">æ£€éªŒå…‰å±±å¿è·¨æ ¡ç§¯æåˆ†å­</button>
        </div>

        <!-- 3. è¡¨æ ¼ç¼–è¾‘åŒºï¼ˆæ ¸å¿ƒåŒºåŸŸï¼‰ -->
        <h3>åœ¨çº¿ç¼–è¾‘åŒº</h3>
        <div id="excelEditorContainer"></div>

        <!-- 4. æäº¤ä¸ä¸‹è½½åŒº -->
        <div class="submit-area">
            <button onclick="submitToCollectForm()" class="btn btn-success" style="padding: 12px 30px; font-size: 1.1em;">
                âœ… å¤„ç†å®Œæˆï¼Œç‚¹å‡»æäº¤
            </button>
            <p style="color:#6c757d; margin-top: 8px;">ç‚¹å‡»åï¼Œå°†è‡ªåŠ¨è·³è½¬åˆ°æ–‡ä»¶æ”¶é›†é¡µé¢</p>
        </div>

        <!-- 5. ä½¿ç”¨è¯´æ˜ -->
        <div class="instructions">
            <p><strong>ä½¿ç”¨æµç¨‹ï¼š</strong></p>
            <p>1. ç‚¹å‡»"é€‰æ‹©Excelæ–‡ä»¶"æŒ‰é’®ä¸Šä¼ æ–‡ä»¶ â†’ 2. è¡¨æ ¼è‡ªåŠ¨åŠ è½½ â†’ 3. ç›´æ¥åŒå‡»å•å…ƒæ ¼ç¼–è¾‘ â†’ 4. ä½¿ç”¨ä¸Šæ–¹å·¥å…·æŒ‰é’®è¿›è¡Œè‡ªåŠ¨åŒ–å¤„ç† â†’ 5. ç‚¹å‡»"ä¸‹è½½å½“å‰è¡¨æ ¼"å¤‡ä»½ â†’ 6. ç‚¹å‡»"æäº¤"æŒ‰é’®è·³è½¬åˆ°æ”¶é›†è¡¨ä¸Šä¼ </p>
            <p><strong>æ³¨æ„ï¼š</strong>æ‰€æœ‰æ“ä½œéƒ½åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­å®Œæˆï¼Œæ•°æ®å®‰å…¨æœ‰ä¿éšœã€‚</p>
        </div>
    </div>

    <!-- 2. å¼•å…¥ SheetJS åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 3. å¼•å…¥ Handsontable åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

    <script>
        // --- å…¨å±€å˜é‡ ---
        let hot; // Handsontable å®ä¾‹
        let currentData = []; // å½“å‰è¡¨æ ¼æ•°æ®
        let currentFileName = '';
        let columnHeaders = []; // å­˜å‚¨åˆ—æ ‡é¢˜

        // --- çŠ¶æ€æç¤ºå‡½æ•° ---
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status status-${type}">${message}</div>`;
            setTimeout(() => {
                if (statusArea.firstChild) {
                    statusArea.firstChild.style.opacity = '0';
                    setTimeout(() => statusArea.innerHTML = '', 500);
                }
            }, 3000);
        }

        // --- Handsontable åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('excelEditorContainer');
            hot = new Handsontable(container, {
                data: [],
                rowHeaders: true,
                colHeaders: true,
                height: '100%',
                width: '100%',
                licenseKey: 'non-commercial-and-evaluation',
                manualRowResize: true,
                manualColumnResize: true,
                contextMenu: true,
                columnSorting: true,
                afterChange: function(changes, source) {
                    if (source === 'loadData') return;
                    // æ›´æ–°å…¨å±€æ•°æ®
                    currentData = hot.getSourceData();
                }
            });

            // æ–‡ä»¶é€‰æ‹©ç›‘å¬
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    loadFile();
                }
            });

            showStatus('è¡¨æ ¼ç¼–è¾‘å™¨å·²å‡†å¤‡å°±ç»ªï¼Œè¯·é€‰æ‹©Excelæ–‡ä»¶å¼€å§‹ä½¿ç”¨ã€‚', 'info');
        });

        // --- è¾…åŠ©å‡½æ•°ï¼šè‡ªåŠ¨è°ƒæ•´åˆ—å®½ ---
        function autoFitColumns() {
            setTimeout(() => {
                const cols = hot.countCols();
                if (cols > 0) {
                    for (let i = 0; i < cols; i++) {
                        hot.setCellMeta(0, i, 'colWidths', 150);
                    }
                    hot.render();
                }
            }, 100);
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        // 1. åŠ è½½Excelæ–‡ä»¶åˆ°è¡¨æ ¼
        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªExcelæ–‡ä»¶', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    showStatus('æ­£åœ¨è§£ææ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // è½¬æ¢ä¸ºäºŒç»´æ•°ç»„ï¼Œä¿ç•™è¡¨å¤´
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length === 0) {
                        showStatus('æ–‡ä»¶ä¸ºç©ºæˆ–æ— æ³•è¯»å–', 'error');
                        return;
                    }

                    // ä¿å­˜åˆ—æ ‡é¢˜ï¼ˆç¬¬ä¸€è¡Œï¼‰
                    columnHeaders = jsonData[0] || [];
                    
                    // åŠ è½½æ•°æ®åˆ°è¡¨æ ¼
                    hot.loadData(jsonData);
                    currentData = jsonData;
                    currentFileName = file.name.replace(/\.[^/.]+$/, "");

                    // è‡ªåŠ¨è°ƒæ•´åˆ—å®½
                    autoFitColumns();
                    
                    showStatus(`âœ… æ–‡ä»¶"${file.name}"åŠ è½½æˆåŠŸï¼å…± ${jsonData.length - 1} è¡Œæ•°æ®ã€‚`, 'success');
                    
                } catch (error) {
                    console.error('è§£æé”™è¯¯:', error);
                    showStatus('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                }
            };

            reader.onerror = function() {
                showStatus('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            };

            reader.readAsArrayBuffer(file);
        }

        // 2. ä»è¡¨æ ¼ä¸‹è½½Excelæ–‡ä»¶
        function saveFile() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¡¨æ ¼ä¸­æ²¡æœ‰æ•°æ®ï¼Œæ— æ³•ä¸‹è½½', 'error');
                return;
            }

            try {
                const data = hot.getData();
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const fileName = currentFileName 
                    ? `${currentFileName}_å·²å¤„ç†_${timestamp}.xlsx`
                    : `å¤„ç†åçš„è¡¨æ ¼_${timestamp}.xlsx`;

                XLSX.writeFile(wb, fileName);
                showStatus(`âœ… æ–‡ä»¶"${fileName}"å·²å¼€å§‹ä¸‹è½½`, 'success');
            } catch (error) {
                console.error('ä¿å­˜é”™è¯¯:', error);
                showStatus('æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // 3. æ¸…ç©ºè¡¨æ ¼
        function clearData() {
            if (hot.countRows() === 0) {
                showStatus('è¡¨æ ¼å·²ç»æ˜¯ç©ºçš„äº†', 'info');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰æ‰€æœ‰è¡¨æ ¼æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                hot.loadData([[]]);
                currentData = [];
                currentFileName = '';
                columnHeaders = [];
                document.getElementById('fileInput').value = '';
                showStatus('è¡¨æ ¼å·²æ¸…ç©º', 'success');
            }
        }

        // 4. å››ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬å‡½æ•°ï¼ˆåŸºç¡€æ¡†æ¶ï¼‰
        function checkAge() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¯·å…ˆåŠ è½½æ•°æ®', 'error');
                return;
            }
            showStatus('æ£€éªŒæ˜¯å¦æ»¡14å‘¨å²åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            // è¿™é‡Œå®ç°å¹´é¾„è®¡ç®—é€»è¾‘
        }

        function markLeague() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¯·å…ˆåŠ è½½æ•°æ®', 'error');
                return;
            }
            showStatus('è‡ªåŠ¨æ ‡è®°æ˜¯å¦å…¥å›¢åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            // è¿™é‡Œå®ç°å…¥å›¢æ ‡è®°é€»è¾‘
        }

        function markGraduation() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¯·å…ˆåŠ è½½æ•°æ®', 'error');
                return;
            }
            showStatus('è‡ªåŠ¨æ ‡è®°æ˜¯å¦æ¯•ä¸šåŠŸèƒ½å¼€å‘ä¸­...', 'info');
            // è¿™é‡Œå®ç°æ¯•ä¸šæ ‡è®°é€»è¾‘
        }

        function checkActivity() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¯·å…ˆåŠ è½½æ•°æ®', 'error');
                return;
            }
            showStatus('æ£€éªŒå…‰å±±å¿è·¨æ ¡ç§¯æåˆ†å­åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            // è¿™é‡Œå®ç°è·¨æ ¡æ£€æŸ¥é€»è¾‘
        }

        // 5. æäº¤åŠŸèƒ½ï¼ˆè‡ªåŠ¨è·³è½¬ï¼‰
        function submitToCollectForm() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¡¨æ ¼ä¸­æ²¡æœ‰æ•°æ®ï¼Œæ— æ³•æäº¤', 'error');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æäº¤å—ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"å°†ï¼š\n1. è‡ªåŠ¨ä¿å­˜å½“å‰è¡¨æ ¼ä¸ºExcelæ–‡ä»¶\n2. è·³è½¬åˆ°æ–‡ä»¶æ”¶é›†é¡µé¢')) {
                try {
                    // å…ˆä¿å­˜æ–‡ä»¶
                    saveFile();
                    
                    // è·³è½¬åˆ°æ”¶é›†è¡¨ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„å®é™…é“¾æ¥ï¼‰
                    const collectFormUrl = 'https://f.wps.cn/g/JaaWyioV/'; // â† é‡è¦ï¼šè¿™é‡Œè¦æ¢æˆä½ çš„é‡‘å±±æ–‡æ¡£æ”¶é›†è¡¨é“¾æ¥
                    
                    setTimeout(() => {
                        window.open(collectFormUrl, '_blank');
                        showStatus('å·²è·³è½¬åˆ°æ”¶é›†è¡¨é¡µé¢ï¼è¯·åœ¨æ‰“å¼€çš„é¡µé¢ä¸­ä¸Šä¼ åˆšåˆšä¸‹è½½çš„æ–‡ä»¶ã€‚', 'success');
                    }, 1000);
                    
                } catch (error) {
                    showStatus('æäº¤è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œè¯·é‡è¯•', 'error');
                }
            }
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // Ctrl+S ä¿å­˜æ–‡ä»¶
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            // Ctrl+O é€‰æ‹©æ–‡ä»¶
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
        });
    </script>
</body>
</html>
