<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿è¡¨æ ¼è‡ªåŠ¨åŒ–å¤„ç†ä¸­å¿ƒ</title>
    <!-- å¼•å…¥ Handsontable çš„æ ·å¼æ–‡ä»¶ -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif; }
        body { margin: 20px; background-color: #f5f7fa; color: #333; }
        .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); padding: 25px; }
        header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        header h1 { color: #2c3e50; margin-bottom: 5px; font-size: 28px; }
        header p { color: #7f8c8d; font-size: 16px; }

        /* åŠŸèƒ½åŒºæ ·å¼ */
        .control-panel { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 6px; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 14px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #d39e00; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #bd2130; }
        .file-input-wrapper { flex-grow: 1; }
        .file-input-wrapper input[type="file"] { 
            padding: 10px; 
            border: 2px dashed #007bff; 
            border-radius: 5px; 
            width: 100%; 
            background: #f8f9fa;
            cursor: pointer;
        }
        .file-input-wrapper input[type="file"]:hover { background: #e9ecef; }

        /* å·¥å…·æ æ ·å¼ */
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: #e9ecef; border-radius: 6px; }
        .toolbar-label { font-weight: bold; color: #495057; margin-right: 10px; align-self: center; font-size: 16px; }

        /* æ ¼å¼å·¥å…·æ  */
        .format-toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 6px; align-items: center; }
        .format-group { display: flex; align-items: center; gap: 8px; border-right: 1px solid #ccc; padding-right: 15px; margin-right: 15px; }
        .format-group:last-child { border-right: none; margin-right: 0; }
        .format-btn, select.format-btn { 
            padding: 8px 12px; 
            background: white; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
            min-height: 36px;
        }
        .format-btn:hover, select.format-btn:hover { background: #e9ecef; }
        .color-picker { width: 36px; height: 36px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; padding: 2px; }

        /* è¡¨æ ¼ç¼–è¾‘åŒºæ ·å¼ */
        #excelEditorContainer { 
            height: 650px; 
            margin-bottom: 20px; 
            border: 2px solid #dee2e6; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* æäº¤ä¸ä¸‹è½½åŒº */
        .submit-area { text-align: center; padding-top: 20px; border-top: 2px solid #eee; margin-top: 30px; }
        .instructions { background-color: #e7f3ff; padding: 20px; border-radius: 8px; margin-top: 30px; border-left: 5px solid #007bff; }
        .instructions p { margin: 8px 0; font-size: 14px; line-height: 1.6; }
        
        /* çŠ¶æ€æç¤º */
        .status { padding: 15px; border-radius: 6px; margin: 15px 0; font-size: 14px; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader { 
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            text-align: center;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <div>æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼Œè¯·ç¨å€™...</div>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ“Š åœ¨çº¿è¡¨æ ¼è‡ªåŠ¨åŒ–å¤„ç†ä¸­å¿ƒ</h1>
            <p>ä¸Šä¼ Excelæ–‡ä»¶ï¼Œä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·å¤„ç†ï¼Œç¼–è¾‘åä¸€é”®æäº¤</p>
        </header>

        <!-- çŠ¶æ€æç¤ºåŒºåŸŸ -->
        <div id="statusArea"></div>

        <!-- 1. ä¸Šä¼ æ–‡ä»¶åŒº -->
        <div class="control-panel">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
                <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary" style="width: 100%; padding: 15px;">
                    ğŸ“ ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶ (.xlsx)
                </button>
                <div id="fileName" style="margin-top: 10px; color: #666; font-size: 14px; text-align: center;">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
            <div style="display: flex; gap: 10px; width: 100%; justify-content: center;">
                <button onclick="saveFile()" class="btn btn-success" style="flex: 1;">ğŸ’¾ ä¸‹è½½å½“å‰è¡¨æ ¼</button>
                <button onclick="clearData()" class="btn btn-danger" style="flex: 1;">ğŸ—‘ï¸ æ¸…ç©ºè¡¨æ ¼</button>
            </div>
        </div>

        <!-- 2. å·¥å…·æ ï¼ˆå››ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬æŒ‰é’®ï¼‰ -->
        <div class="toolbar">
            <div class="toolbar-label">ğŸ”§ è‡ªåŠ¨åŒ–å·¥å…·ï¼š</div>
            <button onclick="checkAge()" class="btn btn-warning">æ£€éªŒæ˜¯å¦æ»¡14å‘¨å²</button>
            <button onclick="markLeague()" class="btn btn-warning">è‡ªåŠ¨æ ‡è®°æ˜¯å¦å…¥å›¢</button>
            <button onclick="markGraduation()" class="btn btn-warning">è‡ªåŠ¨æ ‡è®°æ˜¯å¦æ¯•ä¸š</button>
            <button onclick="checkActivity()" class="btn btn-warning">æ£€éªŒå…‰å±±å¿è·¨æ ¡ç§¯æåˆ†å­</button>
        </div>

        <!-- æ ¼å¼å·¥å…·æ  -->
        <div class="format-toolbar">
            <div class="format-group">
                <span style="font-weight: bold; color: #495057;">å­—ä½“æ ¼å¼ï¼š</span>
                <select id="fontFamily" class="format-btn" onchange="applyFormat('fontFamily', this.value)">
                    <option value="ä»¿å®‹">ä»¿å®‹</option>
                    <option value="é»‘ä½“">é»‘ä½“</option>
                    <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                    <option value="SimSun">å®‹ä½“</option>
                </select>
                <select id="fontSize" class="format-btn" onchange="applyFormat('fontSize', this.value)">
                    <option value="11">11å·</option>
                    <option value="12">12å·</option>
                    <option value="14">14å·</option>
                    <option value="16">16å·</option>
                </select>
                <button class="format-btn" onclick="applyFormat('bold')" title="åŠ ç²—"><b>åŠ ç²—</b></button>
                <button class="format-btn" onclick="applyFormat('italic')" title="æ–œä½“"><i>æ–œä½“</i></button>
                <button class="format-btn" onclick="applyFormat('underline')" title="ä¸‹åˆ’çº¿"><u>ä¸‹åˆ’çº¿</u></button>
            </div>
            <div class="format-group">
                <span style="font-weight: bold; color: #495057;">å¯¹é½æ–¹å¼ï¼š</span>
                <button class="format-btn" onclick="applyFormat('align', 'left')" title="å·¦å¯¹é½">å·¦å¯¹é½</button>
                <button class="format-btn" onclick="applyFormat('align', 'center')" title="å±…ä¸­">å±…ä¸­</button>
                <button class="format-btn" onclick="applyFormat('align', 'right')" title="å³å¯¹é½">å³å¯¹é½</button>
            </div>
            <div class="format-group">
                <span style="font-weight: bold; color: #495057;">é¢œè‰²è®¾ç½®ï¼š</span>
                <div>
                    <div style="font-size: 12px; margin-bottom: 2px;">èƒŒæ™¯è‰²</div>
                    <input type="color" id="bgColor" class="color-picker" value="#ffffff" onchange="applyFormat('bgColor', this.value)">
                </div>
                <div>
                    <div style="font-size: 12px; margin-bottom: 2px;">æ–‡å­—è‰²</div>
                    <input type="color" id="textColor" class="color-picker" value="#000000" onchange="applyFormat('textColor', this.value)">
                </div>
            </div>
            <div class="format-group">
                <span style="font-weight: bold; color: #495057;">è¾¹æ¡†ï¼š</span>
                <button class="format-btn" onclick="applyFormat('border', 'all')">å…¨è¾¹æ¡†</button>
                <button class="format-btn" onclick="applyFormat('border', 'outer')">å¤–è¾¹æ¡†</button>
            </div>
            <div class="format-group">
                <span style="font-weight: bold; color: #495057;">å•å…ƒæ ¼ï¼š</span>
                <button class="format-btn" onclick="mergeCells()">åˆå¹¶</button>
                <button class="format-btn" onclick="unmergeCells()">æ‹†åˆ†</button>
            </div>
        </div>

        <!-- 3. è¡¨æ ¼ç¼–è¾‘åŒºï¼ˆæ ¸å¿ƒåŒºåŸŸï¼‰ -->
        <h3 style="margin-bottom: 10px;">åœ¨çº¿ç¼–è¾‘åŒº</h3>
        <div id="excelEditorContainer"></div>

        <!-- 4. æäº¤ä¸ä¸‹è½½åŒº -->
        <div class="submit-area">
            <button onclick="submitToCollectForm()" class="btn btn-success" style="padding: 15px 40px; font-size: 18px; font-weight: bold;">
                âœ… å¤„ç†å®Œæˆï¼Œç‚¹å‡»æäº¤
            </button>
            <p style="color:#6c757d; margin-top: 12px; font-size: 14px;">ç‚¹å‡»åï¼Œå°†è‡ªåŠ¨è·³è½¬åˆ°æ–‡ä»¶æ”¶é›†é¡µé¢</p>
        </div>

        <!-- 5. ä½¿ç”¨è¯´æ˜ -->
        <div class="instructions">
            <p style="font-weight: bold; color: #007bff; font-size: 16px;">ä½¿ç”¨è¯´æ˜ï¼š</p>
            <p>1. <strong>ç‚¹å‡»"é€‰æ‹©Excelæ–‡ä»¶"æŒ‰é’®</strong>ä¸Šä¼ .xlsxæ ¼å¼çš„æ–‡ä»¶</p>
            <p>2. ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯è¡¨æ ¼æ ¼å¼ï¼ˆA5å•å…ƒæ ¼å¿…é¡»ä¸º"åºå·"ï¼ŒB5å¿…é¡»ä¸º"æ‰¹æ¬¡"ï¼‰</p>
            <p>3. è¡¨æ ¼åŠ è½½åä¼šè‡ªåŠ¨åº”ç”¨æ ‡å‡†æ ¼å¼ï¼šå‰4è¡Œä¿æŒåŸæ ·ï¼Œç¬¬5è¡Œè¡¨å¤´ä¸ºé»‘ä½“14å·ï¼Œå…¶ä»–è¡Œä¸ºä»¿å®‹11å·</p>
            <p>4. ä½¿ç”¨ä¸Šæ–¹å·¥å…·æ è¿›è¡Œæ ¼å¼ç¼–è¾‘ï¼Œæˆ–ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·å¤„ç†æ•°æ®</p>
            <p>5. å¤„ç†å®Œæˆåç‚¹å‡»"ä¸‹è½½å½“å‰è¡¨æ ¼"å¤‡ä»½</p>
            <p>6. æœ€åç‚¹å‡»"æäº¤"æŒ‰é’®è·³è½¬åˆ°æ”¶é›†è¡¨é¡µé¢</p>
            <p style="color: #dc3545; font-weight: bold;">æ³¨æ„ï¼šæ‰€æœ‰æ“ä½œéƒ½åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œæ•°æ®å®‰å…¨æœ‰ä¿éšœã€‚</p>
        </div>
    </div>

    <!-- å¼•å…¥ SheetJS åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ Handsontable åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <!-- å¼•å…¥ä¸­æ–‡è¯­è¨€åŒ… -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable/languages/zh-CN.min.js"></script>

    <script>
        // --- å…¨å±€å˜é‡ ---
        let hot; // Handsontable å®ä¾‹
        let currentData = []; // å½“å‰è¡¨æ ¼æ•°æ®
        let currentFileName = '';
        let isFormatApplied = false; // æ ‡è®°æ˜¯å¦å·²åº”ç”¨æ ¼å¼
        const columnWidths = { // åˆ—å®½å®šä¹‰ï¼ˆåƒç´ ï¼‰
            'A': 64, 'B': 128, 'C': 64, 'D': 64, 'E': 240,
            'F': 88, 'G': 96, 'H': 64, 'I': 200, 'J': 64,
            'K': 64, 'L': 96, 'M': 96, 'N': 96, 'O': 96,
            'P': 96, 'Q': 240, 'R': 96, 'S': 240, 'T': 96
        };

        // --- å·¥å…·å‡½æ•° ---
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status status-${type}">${message}</div>`;
            setTimeout(() => {
                if (statusArea.firstChild) {
                    statusArea.firstChild.style.opacity = '0';
                    setTimeout(() => statusArea.innerHTML = '', 3000);
                }
            }, 5000);
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        // --- æ–‡ä»¶ä¸Šä¼ å¤„ç† ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                document.getElementById('fileName').innerHTML = `å·²é€‰æ‹©æ–‡ä»¶: ${file.name}`;
                loadFile(file);
            }
        });

        // --- Handsontable åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('excelEditorContainer');
            
            // é…ç½®ä¸­æ–‡ä¸Šä¸‹æ–‡èœå•
            const contextMenuItems = {
                'row_above': { name: 'ä¸Šæ–¹æ’å…¥è¡Œ' },
                'row_below': { name: 'ä¸‹æ–¹æ’å…¥è¡Œ' },
                'col_left': { name: 'å·¦ä¾§æ’å…¥åˆ—' },
                'col_right': { name: 'å³ä¾§æ’å…¥åˆ—' },
                'remove_row': { name: 'åˆ é™¤è¡Œ' },
                'remove_col': { name: 'åˆ é™¤åˆ—' },
                'alignment': { name: 'å¯¹é½æ–¹å¼' },
                'mergeCells': { name: 'åˆå¹¶å•å…ƒæ ¼' },
                'undo': { name: 'æ’¤é”€' },
                'redo': { name: 'é‡åš' },
                'copy': { name: 'å¤åˆ¶' },
                'cut': { name: 'å‰ªåˆ‡' },
                'freeze_column': { name: 'å†»ç»“åˆ—' },
                'unfreeze_column': { name: 'å–æ¶ˆå†»ç»“åˆ—' },
                'filter_by_condition': { name: 'æ¡ä»¶ç­›é€‰' },
                'filter_by_value': { name: 'å€¼ç­›é€‰' },
                'filter_action_bar': { name: 'ç­›é€‰å·¥å…·æ ' }
            };
            
            hot = new Handsontable(container, {
                data: [],
                rowHeaders: true,
                colHeaders: true,
                height: '100%',
                width: '100%',
                licenseKey: 'non-commercial-and-evaluation',
                language: Handsontable.languages['zh-CN'],
                contextMenu: contextMenuItems,
                filters: true,
                dropdownMenu: ['filter_by_condition', 'filter_by_value', 'filter_action_bar'],
                manualRowResize: true,
                manualColumnResize: true,
                manualRowMove: true,
                manualColumnMove: true,
                columnSorting: true,
                mergeCells: true,
                stretchH: 'all',
                wordWrap: false,
                columns: null,
                colWidths: null,
                afterChange: function(changes, source) {
                    if (source === 'loadData') return;
                    currentData = hot.getSourceData();
                }
            });

            showStatus('è¡¨æ ¼ç¼–è¾‘å™¨å·²å°±ç»ªï¼Œè¯·é€‰æ‹©Excelæ–‡ä»¶å¼€å§‹ä½¿ç”¨ã€‚', 'info');
        });

        // --- æ–‡ä»¶åŠ è½½å‡½æ•° ---
        function loadFile(file) {
            if (!file) {
                const fileInput = document.getElementById('fileInput');
                if (fileInput.files.length === 0) {
                    showStatus('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }
                file = fileInput.files[0];
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                showStatus('åªæ”¯æŒ .xlsx æ ¼å¼çš„æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹©', 'error');
                document.getElementById('fileInput').value = '';
                document.getElementById('fileName').innerHTML = 'æœªé€‰æ‹©æ–‡ä»¶';
                return;
            }

            showLoader(true);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    showStatus('æ­£åœ¨è§£ææ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellStyles: true,
                        raw: false
                    });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // è½¬æ¢ä¸ºäºŒç»´æ•°ç»„
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    console.log('è§£æåˆ°çš„æ•°æ®ç»´åº¦:', jsonData.length, 'è¡Œ', jsonData[0] ? jsonData[0].length : 0, 'åˆ—');
                    
                    // éªŒè¯è¡¨æ ¼æ ¼å¼
                    const validation = validateTableFormat(jsonData);
                    if (!validation.valid) {
                        showLoader(false);
                        showStatus(validation.message, 'error');
                        document.getElementById('fileInput').value = '';
                        document.getElementById('fileName').innerHTML = 'æœªé€‰æ‹©æ–‡ä»¶';
                        return;
                    }
                    
                    // æ¸…ç©ºå¹¶åŠ è½½æ•°æ®
                    hot.loadData(jsonData);
                    currentData = jsonData;
                    currentFileName = file.name.replace(/\.[^/.]+$/, "");
                    
                    // åº”ç”¨æ ‡å‡†æ ¼å¼
                    setTimeout(() => {
                        applyStandardFormat();
                        showLoader(false);
                        showStatus(`âœ… æ–‡ä»¶"${file.name}"åŠ è½½æˆåŠŸï¼å…± ${jsonData.length} è¡Œæ•°æ®ã€‚`, 'success');
                    }, 100);
                    
                } catch (error) {
                    console.error('è§£æé”™è¯¯:', error);
                    showLoader(false);
                    showStatus('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message, 'error');
                    document.getElementById('fileInput').value = '';
                    document.getElementById('fileName').innerHTML = 'æœªé€‰æ‹©æ–‡ä»¶';
                }
            };

            reader.onerror = function() {
                showLoader(false);
                showStatus('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                document.getElementById('fileInput').value = '';
                document.getElementById('fileName').innerHTML = 'æœªé€‰æ‹©æ–‡ä»¶';
            };

            reader.readAsArrayBuffer(file);
        }

        // --- æ ¼å¼éªŒè¯å‡½æ•° ---
        function validateTableFormat(data) {
            if (data.length < 5) {
                return { valid: false, message: "è¡¨æ ¼è¡Œæ•°ä¸è¶³5è¡Œï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼" };
            }
            
            const a5Value = data[4] && data[4][0] ? String(data[4][0]).trim() : '';
            const b5Value = data[4] && data[4][1] ? String(data[4][1]).trim() : '';
            
            if (a5Value !== 'åºå·' || b5Value !== 'æ‰¹æ¬¡') {
                return { 
                    valid: false, 
                    message: `è¡¨æ ¼æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼<br>è¯·ç¡®ä¿ï¼š<br>1. A5å•å…ƒæ ¼ä¸º"åºå·"ï¼ˆå½“å‰ï¼š${a5Value || 'ç©º'}ï¼‰<br>2. B5å•å…ƒæ ¼ä¸º"æ‰¹æ¬¡"ï¼ˆå½“å‰ï¼š${b5Value || 'ç©º'}ï¼‰<br><br>è¯·å‹¿åˆ é™¤æˆ–æ›´æ”¹è¡¨å¤´åŒºåŸŸï¼ˆå‰5è¡Œï¼‰`
                };
            }
            
            return { valid: true, message: "è¡¨æ ¼æ ¼å¼éªŒè¯é€šè¿‡" };
        }

        // --- åº”ç”¨æ ‡å‡†æ ¼å¼å‡½æ•° ---
        function applyStandardFormat() {
            if (!hot || hot.countRows() === 0) return;
            
            const totalRows = hot.countRows();
            const totalCols = hot.countCols();
            
            console.log('åº”ç”¨æ ¼å¼åˆ°è¡¨æ ¼:', totalRows, 'è¡Œ', totalCols, 'åˆ—');
            
            // è®¾ç½®åˆ—å®½
            for (let col = 0; col < totalCols; col++) {
                const colLetter = String.fromCharCode(65 + col);
                const width = columnWidths[colLetter] || 100;
                hot.setCellMeta(0, col, 'colWidths', width);
            }
            
            // è®¾ç½®è¡Œé«˜
            for (let row = 0; row < totalRows; row++) {
                if (row === 4) { // ç¬¬5è¡Œï¼ˆç´¢å¼•4ï¼‰
                    hot.setCellMeta(row, 0, 'rowHeight', 80);
                    // è®¾ç½®ç¬¬5è¡Œæ ·å¼ï¼šé»‘ä½“ã€14å·ã€å±…ä¸­ã€è‡ªåŠ¨æ¢è¡Œ
                    for (let col = 0; col < totalCols; col++) {
                        hot.setCellMeta(row, col, 'className', 'header-row');
                        const renderer = hot.getCellMeta(row, col).renderer || function(instance, td) {
                            Handsontable.renderers.TextRenderer.apply(this, arguments);
                        };
                        
                        hot.setCellMeta(row, col, 'renderer', function(instance, td, row, col, prop, value, cellProperties) {
                            renderer.call(this, instance, td, row, col, prop, value, cellProperties);
                            td.style.fontFamily = 'é»‘ä½“, Microsoft YaHei, sans-serif';
                            td.style.fontSize = '14px';
                            td.style.fontWeight = 'bold';
                            td.style.textAlign = 'center';
                            td.style.verticalAlign = 'middle';
                            td.style.whiteSpace = 'normal';
                            td.style.wordWrap = 'break-word';
                            td.style.border = '1px solid #000';
                            td.style.backgroundColor = '#f2f2f2';
                            td.style.padding = '5px';
                        });
                    }
                } else if (row >= 5) { // ç¬¬6è¡Œå¼€å§‹
                    hot.setCellMeta(row, 0, 'rowHeight', 20);
                    // è®¾ç½®å…¶ä»–è¡Œæ ·å¼ï¼šä»¿å®‹ã€11å·ã€å±…ä¸­ã€ä¸æ¢è¡Œ
                    for (let col = 0; col < totalCols; col++) {
                        hot.setCellMeta(row, col, 'className', 'data-row');
                        const renderer = hot.getCellMeta(row, col).renderer || function(instance, td) {
                            Handsontable.renderers.TextRenderer.apply(this, arguments);
                        };
                        
                        hot.setCellMeta(row, col, 'renderer', function(instance, td, row, col, prop, value, cellProperties) {
                            renderer.call(this, instance, td, row, col, prop, value, cellProperties);
                            td.style.fontFamily = 'ä»¿å®‹, FangSong, serif';
                            td.style.fontSize = '11px';
                            td.style.textAlign = 'center';
                            td.style.verticalAlign = 'middle';
                            td.style.whiteSpace = 'nowrap';
                            td.style.overflow = 'hidden';
                            td.style.textOverflow = 'ellipsis';
                            td.style.border = '1px solid #ccc';
                            td.style.padding = '2px';
                        });
                    }
                }
            }
            
            // è®¾ç½®åˆ—æ ‡é¢˜
            if (totalRows > 0 && currentData[4]) {
                const headers = currentData[4];
                hot.updateSettings({
                    colHeaders: headers
                });
            }
            
            hot.render();
            isFormatApplied = true;
            console.log('æ ‡å‡†æ ¼å¼å·²åº”ç”¨å®Œæˆ');
        }

        // --- æ ¼å¼å·¥å…·æ åŠŸèƒ½ ---
        function applyFormat(type, value = null) {
            const selected = hot.getSelected();
            if (!selected || selected.length === 0) {
                showStatus('è¯·å…ˆé€‰æ‹©è¦æ ¼å¼åŒ–çš„å•å…ƒæ ¼', 'info');
                return;
            }

            for (let r = selected[0]; r <= selected[2]; r++) {
                for (let c = selected[1]; c <= selected[3]; c++) {
                    const cellMeta = hot.getCellMeta(r, c);
                    const originalRenderer = cellMeta.renderer || function(instance, td) {
                        Handsontable.renderers.TextRenderer.apply(this, arguments);
                    };
                    
                    hot.setCellMeta(r, c, 'renderer', function(instance, td, row, col, prop, val, cellProps) {
                        originalRenderer.call(this, instance, td, row, col, prop, val, cellProps);
                        
                        switch(type) {
                            case 'fontFamily':
                                td.style.fontFamily = value;
                                break;
                            case 'fontSize':
                                td.style.fontSize = value + 'px';
                                break;
                            case 'bold':
                                td.style.fontWeight = td.style.fontWeight === 'bold' ? 'normal' : 'bold';
                                break;
                            case 'italic':
                                td.style.fontStyle = td.style.fontStyle === 'italic' ? 'normal' : 'italic';
                                break;
                            case 'underline':
                                td.style.textDecoration = td.style.textDecoration === 'underline' ? 'none' : 'underline';
                                break;
                            case 'align':
                                td.style.textAlign = value;
                                break;
                            case 'bgColor':
                                td.style.backgroundColor = value;
                                break;
                            case 'textColor':
                                td.style.color = value;
                                break;
                            case 'border':
                                if (value === 'all') {
                                    td.style.border = '1px solid #000';
                                } else if (value === 'outer') {
                                    if (r === selected[0]) td.style.borderTop = '2px solid #000';
                                    if (r === selected[2]) td.style.borderBottom = '2px solid #000';
                                    if (c === selected[1]) td.style.borderLeft = '2px solid #000';
                                    if (c === selected[3]) td.style.borderRight = '2px solid #000';
                                }
                                break;
                        }
                    });
                }
            }
            hot.render();
            showStatus('æ ¼å¼å·²åº”ç”¨', 'success');
        }

        function mergeCells() {
            const selected = hot.getSelected();
            if (!selected || selected[0] === selected[2] && selected[1] === selected[3]) {
                showStatus('è¯·é€‰æ‹©å¤šä¸ªå•å…ƒæ ¼è¿›è¡Œåˆå¹¶', 'info');
                return;
            }
            
            hot.mergeCells({
                row: selected[0],
                col: selected[1],
                rowspan: selected[2] - selected[0] + 1,
                colspan: selected[3] - selected[1] + 1
            });
            hot.render();
            showStatus('å•å…ƒæ ¼å·²åˆå¹¶', 'success');
        }

        function unmergeCells() {
            const selected = hot.getSelected();
            if (!selected) {
                showStatus('è¯·é€‰æ‹©è¦æ‹†åˆ†çš„å•å…ƒæ ¼', 'info');
                return;
            }
            
            hot.unmergeCells(selected[0], selected[1], selected[2], selected[3]);
            hot.render();
            showStatus('å•å…ƒæ ¼å·²æ‹†åˆ†', 'success');
        }

        // --- æ–‡ä»¶ä¿å­˜åŠŸèƒ½ ---
        function saveFile() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¡¨æ ¼ä¸­æ²¡æœ‰æ•°æ®ï¼Œæ— æ³•ä¸‹è½½', 'error');
                return;
            }

            try {
                const data = hot.getData();
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const fileName = currentFileName 
                    ? `${currentFileName}_å·²å¤„ç†_${timestamp}.xlsx`
                    : `å¤„ç†åçš„è¡¨æ ¼_${timestamp}.xlsx`;

                XLSX.writeFile(wb, fileName);
                showStatus(`âœ… æ–‡ä»¶"${fileName}"å·²å¼€å§‹ä¸‹è½½`, 'success');
            } catch (error) {
                console.error('ä¿å­˜é”™è¯¯:', error);
                showStatus('æ–‡ä»¶ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // --- æ¸…ç©ºè¡¨æ ¼ ---
        function clearData() {
            if (hot.countRows() === 0) {
                showStatus('è¡¨æ ¼å·²ç»æ˜¯ç©ºçš„äº†', 'info');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰æ‰€æœ‰è¡¨æ ¼æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                hot.loadData([[]]);
                currentData = [];
                currentFileName = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('fileName').innerHTML = 'æœªé€‰æ‹©æ–‡ä»¶';
                isFormatApplied = false;
                showStatus('è¡¨æ ¼å·²æ¸…ç©º', 'success');
            }
        }

        // --- è‡ªåŠ¨åŒ–è„šæœ¬å‡½æ•° ---
        function checkAge() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¯·å…ˆåŠ è½½æ•°æ®', 'error');
                return;
            }
            
            const totalRows = hot.countRows();
            const birthDateCol = findColumnIndex('å‡ºç”Ÿæ—¥æœŸ') || 2; // é»˜è®¤Cåˆ—
            const resultCol = findColumnIndex('æ˜¯å¦æ»¡14å‘¨å²') || hot.countCols();
            
            let updated = 0;
            for (let row = 5; row < totalRows; row++) {
                const birthDate = hot.getDataAtCell(row, birthDateCol);
                if (birthDate && typeof birthDate === 'string') {
                    try {
                        const birth = new Date(birthDate);
                        const today = new Date();
                        let age = today.getFullYear() - birth.getFullYear();
                        const monthDiff = today.getMonth() - birth.getMonth();
                        
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                            age--;
                        }
                        
                        hot.setDataAtCell(row, resultCol, age >= 14 ? 'æ˜¯' : 'å¦');
                        updated++;
                    } catch (e) {
                        hot.setDataAtCell(row, resultCol, 'æ—¥æœŸæ ¼å¼é”™è¯¯');
                    }
                }
            }
            
            showStatus(`âœ… å·²æ£€éªŒ ${updated} æ¡è®°å½•çš„å¹´é¾„`, 'success');
        }

        function markLeague() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¯·å…ˆåŠ è½½æ•°æ®', 'error');
                return;
            }
            
            const totalRows = hot.countRows();
            const resultCol = findColumnIndex('æ˜¯å¦å…¥å›¢') || hot.countCols();
            
            let updated = 0;
            for (let row = 5; row < totalRows; row++) {
                // è¿™é‡Œæ·»åŠ ä½ çš„å…¥å›¢æ ‡è®°é€»è¾‘
                hot.setDataAtCell(row, resultCol, 'å¾…æ ‡è®°');
                updated++;
            }
            
            showStatus(`âœ… å·²æ ‡è®° ${updated} æ¡è®°å½•çš„å…¥å›¢çŠ¶æ€`, 'success');
        }

        function markGraduation() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¯·å…ˆåŠ è½½æ•°æ®', 'error');
                return;
            }
            
            const totalRows = hot.countRows();
            const resultCol = findColumnIndex('æ˜¯å¦æ¯•ä¸š') || hot.countCols();
            
            let updated = 0;
            for (let row = 5; row < totalRows; row++) {
                // è¿™é‡Œæ·»åŠ ä½ çš„æ¯•ä¸šæ ‡è®°é€»è¾‘
                hot.setDataAtCell(row, resultCol, 'å¾…æ ‡è®°');
                updated++;
            }
            
            showStatus(`âœ… å·²æ ‡è®° ${updated} æ¡è®°å½•çš„æ¯•ä¸šçŠ¶æ€`, 'success');
        }

        function checkActivity() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¯·å…ˆåŠ è½½æ•°æ®', 'error');
                return;
            }
            
            showStatus('æ­£åœ¨æ£€éªŒå…‰å±±å¿è·¨æ ¡ç§¯æåˆ†å­...', 'info');
            // è¿™é‡Œæ·»åŠ ä½ çš„è·¨æ ¡æ£€æŸ¥é€»è¾‘
            
            setTimeout(() => {
                showStatus('âœ… è·¨æ ¡ç§¯æåˆ†å­æ£€éªŒå®Œæˆ', 'success');
            }, 1000);
        }

        function findColumnIndex(headerName) {
            if (!currentData[4]) return null;
            return currentData[4].findIndex(col => String(col).trim() === headerName);
        }

        // --- æäº¤åŠŸèƒ½ ---
        function submitToCollectForm() {
            if (!hot || hot.countRows() === 0) {
                showStatus('è¡¨æ ¼ä¸­æ²¡æœ‰æ•°æ®ï¼Œæ— æ³•æäº¤', 'error');
                return;
            }
            
            // éªŒè¯æ ¼å¼
            const data = hot.getData();
            const validation = validateTableFormat(data);
            if (!validation.valid) {
                showStatus(validation.message, 'error');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æäº¤å—ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"å°†ï¼š\n1. è‡ªåŠ¨ä¿å­˜å½“å‰è¡¨æ ¼ä¸ºExcelæ–‡ä»¶\n2. è·³è½¬åˆ°æ–‡ä»¶æ”¶é›†é¡µé¢')) {
                try {
                    saveFile();
                    
                    const collectFormUrl = 'https://f.wps.cn/xxxxx'; // æ›¿æ¢ä¸ºä½ çš„æ”¶é›†è¡¨é“¾æ¥
                    
                    setTimeout(() => {
                        window.open(collectFormUrl, '_blank');
                        showStatus('å·²è·³è½¬åˆ°æ”¶é›†è¡¨é¡µé¢ï¼è¯·åœ¨æ‰“å¼€çš„é¡µé¢ä¸­ä¸Šä¼ åˆšåˆšä¸‹è½½çš„æ–‡ä»¶ã€‚', 'success');
                    }, 1000);
                    
                } catch (error) {
                    showStatus('æäº¤è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œè¯·é‡è¯•', 'error');
                }
            }
        }

        // --- é”®ç›˜å¿«æ·é”® ---
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
        });
    </script>
</body>
</html>
