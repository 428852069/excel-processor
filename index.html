<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ•°æ®åœ¨çº¿å¤„ç†å·¥å…·</title>
    <!-- Luckysheet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css" />
    <style>
        body { font-family: sans-serif; margin: 30px; background: #f4f4f4; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .upload-section { padding: 20px; border: 2px dashed #4CAF50; border-radius: 8px; text-align: center; margin: 20px 0; background: #f9f9f9; }
        #fileInput { margin: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #loadBtn { background: #4CAF50; color: white; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        #loadBtn:hover { background: #45a049; }
        .tools-section { background: #e8f4fc; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 5px solid #2196F3; }
        .custom-toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .tool-btn { background: #555; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; flex: 1; min-width: 200px; }
        .tool-btn:hover { opacity: 0.9; }
        .tool-btn:nth-child(1) { background: #f44336; } /* é—®é¢˜æ’æŸ¥ */
        .tool-btn:nth-child(2) { background: #9C27B0; } /* å¹´é¾„æ£€æŸ¥ */
        .tool-btn:nth-child(3) { background: #2196F3; } /* å…¥å›¢æ ‡è®° */
        .tool-btn:nth-child(4) { background: #009688; } /* æ¯•ä¸šæ ‡è®° */
        .tool-btn:nth-child(5) { background: #FF9800; } /* ç§¯æåˆ†å­æ£€æŸ¥ */
        #luckysheet { width: 100%; height: 550px; margin: 20px 0; border: 1px solid #ddd; border-radius: 5px; }
        .action-buttons { text-align: center; margin-top: 30px; }
        .action-btn { padding: 15px 35px; margin: 0 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        #downloadBtn { background: #4CAF50; color: white; }
        #submitFormBtn { background: #FF5722; color: white; }
        .instructions { margin-top: 30px; padding: 15px; background: #fffde7; border-radius: 5px; border-left: 4px solid #ffc107; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ Excel æ•°æ®åœ¨çº¿å¤„ç†å·¥å…·</h1>
        <p style="text-align: center; color: #666;">ä¸Šä¼  .xlsx æ–‡ä»¶ï¼Œåœ¨çº¿ç¼–è¾‘å¹¶ä½¿ç”¨å®šåˆ¶å·¥å…·å¤„ç†æ•°æ®ã€‚</p>

        <div class="upload-section">
            <h3>ç¬¬ä¸€æ­¥ï¼šä¸Šä¼  Excel æ–‡ä»¶</h3>
            <p>ä»…æ”¯æŒ <strong>.xlsx</strong> æ ¼å¼</p>
            <input type="file" id="fileInput" accept=".xlsx">
            <br>
            <button id="loadBtn">åŠ è½½åˆ°åœ¨çº¿è¡¨æ ¼</button>
        </div>

        <div class="tools-section">
            <h3>ç¬¬äºŒæ­¥ï¼šä½¿ç”¨å·¥å…·å¤„ç†æ•°æ®ï¼ˆç‚¹å‡»æŒ‰é’®è¿è¡Œè„šæœ¬ï¼‰</h3>
            <div class="custom-toolbar">
                <button class="tool-btn" onclick="runCommonIssueCheck()">ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥</button>
                <button class="tool-btn" onclick="checkAgeOver14()">ğŸ‘¤ æ£€éªŒæ˜¯å¦æ»¡14å‘¨å²</button>
                <button class="tool-btn" onclick="markLeagueMember()">ğŸ… è‡ªåŠ¨æ ‡è®°æ˜¯å¦å…¥å›¢</button>
                <button class="tool-btn" onclick="markGraduation()">ğŸ“ è‡ªåŠ¨æ ‡è®°æ˜¯å¦æ¯•ä¸š</button>
                <button class="tool-btn" onclick="checkActivistInOtherSchool()">ğŸ“‹ æ£€éªŒå…‰å±±å¿å…¶ä»–å­¦æ ¡ç§¯æåˆ†å­</button>
            </div>
            <p><small>æç¤ºï¼šè„šæœ¬ä¼šç›´æ¥ä¿®æ”¹è¡¨æ ¼ã€‚è¯·æ ¹æ®æ‚¨çš„è¡¨æ ¼ç»“æ„ï¼ˆåˆ—å·ã€æ ‡é¢˜ï¼‰ä¿®æ”¹ä¸‹æ–¹ä»£ç ä¸­çš„å‡½æ•°é€»è¾‘ã€‚</small></p>
        </div>

        <h3>åœ¨çº¿è¡¨æ ¼ç¼–è¾‘å™¨</h3>
        <div id="luckysheet"></div>

        <div class="action-buttons">
            <button class="action-btn" id="downloadBtn">ğŸ’¾ ä¸‹è½½å¤„ç†åçš„è¡¨æ ¼</button>
            <!-- å…³é”®ä¿®å¤1ï¼šé“¾æ¥å·²æ›¿æ¢ä¸ºæ‚¨æä¾›çš„WPSè¡¨å•åœ°å€ -->
            <button class="action-btn" id="submitFormBtn">ğŸš€ è·³è½¬è‡³æäº¤è¡¨å• (WPS)</button>
        </div>

        <div class="instructions">
            <h4>ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
            <ul>
                <li><strong>æ–‡ä»¶å¤„ç†å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œ</strong>ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚</li>
                <li>åŠ è½½æ–‡ä»¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸Šæ–¹æŒ‰é’®è¿è¡Œå®šåˆ¶è„šæœ¬ã€‚æ‚¨éœ€è¦æ ¹æ®å®é™…è¡¨æ ¼çš„åˆ—ç»“æ„ï¼ˆä¾‹å¦‚ï¼Œå‡ºç”Ÿæ—¥æœŸåœ¨å“ªä¸€åˆ—ï¼‰ä¿®æ”¹é¡µé¢åº•éƒ¨ &lt;script&gt; æ ‡ç­¾å†…çš„å¯¹åº”å‡½æ•°ã€‚</li>
                <li>ä¸‹è½½çš„æ–‡ä»¶åä¸º <code>processed_data_æ—¶é—´æˆ³.xlsx</code>ã€‚</li>
                <li>æœ€åï¼Œç‚¹å‡»â€œè·³è½¬è‡³æäº¤è¡¨å•â€æŒ‰é’®ï¼Œä¼šæ–°çª—å£æ‰“å¼€WPSè¡¨å•é¡µé¢ï¼Œä¾›æ‚¨æäº¤æœ€ç»ˆæ–‡ä»¶ã€‚</li>
            </ul>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        let luckySheetInstance = null;
        let currentWorkbook = null;

        // 1. åŠ è½½ä¸Šä¼ çš„Excelæ–‡ä»¶ (å…³é”®ä¿®å¤2ï¼šè§£å†³åªæ˜¾ç¤ºAåˆ—çš„é—®é¢˜)
        document.getElementById('loadBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file || !file.name.endsWith('.xlsx')) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ª .xlsx æ ¼å¼çš„æ–‡ä»¶ï¼');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, {type: 'binary'});
                    currentWorkbook = workbook;

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // **ä¿®å¤æ ¸å¿ƒï¼šè·å–å·¥ä½œè¡¨çš„æœ€å¤§èŒƒå›´ï¼ˆä¾‹å¦‚ A1:Z100ï¼‰**
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    const rowCount = range.e.r + 1; // ç»“æŸè¡Œå· + 1
                    const colCount = range.e.c + 1; // ç»“æŸåˆ—å· + 1

                    // **åˆ›å»ºä¸€ä¸ªäºŒç»´æ•°ç»„â€œç½‘æ ¼â€ï¼Œå¹¶ç”¨æ•°æ®å¡«å……å®ƒ**
                    const sheetArray = [];
                    for (let r = 0; r < rowCount; r++) {
                        sheetArray[r] = new Array(colCount).fill(null);
                    }
                    // éå†å·¥ä½œè¡¨çš„æ‰€æœ‰å•å…ƒæ ¼ï¼Œæ”¾å…¥æ­£ç¡®ä½ç½®
                    for (const cellAddress in worksheet) {
                        if (cellAddress[0] === '!') continue; // è·³è¿‡ç‰¹æ®Šé”®ï¼ˆå¦‚!refï¼‰
                        const cell = XLSX.utils.decode_cell(cellAddress);
                        sheetArray[cell.r][cell.c] = worksheet[cellAddress].v;
                    }

                    // å‡†å¤‡Luckysheeté€‰é¡¹
                    const options = {
                        container: 'luckysheet',
                        title: file.name,
                        lang: 'zh',
                        showtoolbar: true,
                        showinfobar: true,
                        showsheetbar: true,
                        data: [{
                            name: firstSheetName,
                            data: sheetArray, // ä½¿ç”¨å®Œæ•´çš„ç½‘æ ¼æ•°æ®
                            order: 0,
                            row: rowCount,
                            column: colCount,
                        }],
                    };

                    // åˆå§‹åŒ–Luckysheet
                    if (luckySheetInstance) {
                        luckysheet.destroy();
                    }
                    luckySheetInstance = luckysheet.create(options);
                    alert('æ–‡ä»¶åŠ è½½æˆåŠŸï¼è¡¨æ ¼æ˜¾ç¤ºå·²ä¿®å¤ã€‚');

                } catch (error) {
                    console.error('é”™è¯¯:', error);
                    alert('åŠ è½½æ–‡ä»¶æ—¶å‡ºé”™ï¼š' + error.message);
                }
            };
            reader.readAsBinaryString(file);
        });

        // ============================================
        // 2. è‡ªå®šä¹‰å·¥å…·å‡½æ•° (æ‚¨éœ€è¦æ ¹æ®å®é™…è¡¨æ ¼ç»“æ„ä¿®æ”¹å…·ä½“é€»è¾‘)
        // ============================================
        function runCommonIssueCheck() {
            if (!luckySheetInstance) { alert('è¯·å…ˆåŠ è½½è¡¨æ ¼ï¼'); return; }
            alert('â€œå¸¸è§é—®é¢˜æ’æŸ¥â€è„šæœ¬å·²æ‰§è¡Œã€‚\nè¯·æ ¹æ®æ‚¨çš„è¡¨æ ¼ç»“æ„ä¿®æ”¹æ­¤å‡½æ•°å†…çš„é€»è¾‘ã€‚');
            // TODO: ä¾‹å¦‚ï¼Œæ£€æŸ¥å…³é”®åˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¹¶åœ¨å¤‡æ³¨åˆ—æ ‡è®°ã€‚
        }
        function checkAgeOver14() {
            if (!luckySheetInstance) { alert('è¯·å…ˆåŠ è½½è¡¨æ ¼ï¼'); return; }
            alert('â€œæ£€éªŒæ˜¯å¦æ»¡14å‘¨å²â€è„šæœ¬å·²æ‰§è¡Œã€‚\nè¯·æ ¹æ®æ‚¨çš„è¡¨æ ¼ç»“æ„ä¿®æ”¹æ­¤å‡½æ•°å†…çš„é€»è¾‘ã€‚');
            // TODO: ç¤ºä¾‹é€»è¾‘ï¼šå‡è®¾Cåˆ—(ç´¢å¼•2)æ˜¯â€œå‡ºç”Ÿæ—¥æœŸâ€ã€‚
            // const sheet = luckysheet.getSheet();
            // const data = sheet.data;
            // for(let r = 1; r < data.length; r++) {
            //   const birthStr = data[r] && data[r][2];
            //   if(birthStr){
            //     const birth = new Date(birthStr);
            //     const age = new Date().getFullYear() - birth.getFullYear();
            //     luckysheet.setCellValue(r, 3, age >= 14 ? 'æ˜¯' : 'å¦'); // ç»“æœå†™åˆ°Dåˆ—
            //   }
            // }
        }
        function markLeagueMember() {
            alert('â€œè‡ªåŠ¨æ ‡è®°æ˜¯å¦å…¥å›¢â€è„šæœ¬æ¡†æ¶ã€‚è¯·ä¿®æ”¹å‡½æ•°é€»è¾‘ã€‚');
        }
        function markGraduation() {
            alert('â€œè‡ªåŠ¨æ ‡è®°æ˜¯å¦æ¯•ä¸šâ€è„šæœ¬æ¡†æ¶ã€‚è¯·ä¿®æ”¹å‡½æ•°é€»è¾‘ã€‚');
        }
        function checkActivistInOtherSchool() {
            alert('â€œæ£€éªŒå…‰å±±å¿å…¶ä»–å­¦æ ¡ç§¯æåˆ†å­â€è„šæœ¬æ¡†æ¶ã€‚è¯·ä¿®æ”¹å‡½æ•°é€»è¾‘ã€‚');
        }

        // ============================================
        // 3. ä¸‹è½½å¤„ç†åçš„è¡¨æ ¼
        // ============================================
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (!luckySheetInstance) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„è¡¨æ ¼æ•°æ®ï¼');
                return;
            }
            try {
                const sheet = luckysheet.getSheet();
                const sheetArray = luckysheet.getSheetData();

                const ws = XLSX.utils.aoa_to_sheet(sheetArray);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                const wbout = XLSX.write(wb, {bookType:'xlsx', type:'binary'});
                const blob = new Blob([s2ab(wbout)], {type:"application/octet-stream"});
                saveAs(blob, `processed_data_${Date.now()}.xlsx`);
                alert('æ–‡ä»¶ä¸‹è½½å¼€å§‹ï¼');
            } catch (error) {
                console.error('å¯¼å‡ºé”™è¯¯:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        });
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        // ============================================
        // 4. è·³è½¬è‡³æäº¤è¡¨å• (å…³é”®ä¿®å¤1ï¼šé“¾æ¥å·²æ›¿æ¢)
        // ============================================
        document.getElementById('submitFormBtn').addEventListener('click', function() {
            // **æ­¤å¤„å·²ç›´æ¥ä½¿ç”¨æ‚¨æä¾›çš„WPSè¡¨å•é“¾æ¥**
            const formUrl = "https://f.wps.cn/g/JaaWyioV";
            const confirmJump = confirm(`è¯·ç¡®ä¿å·²ä¸‹è½½æœ€ç»ˆæ–‡ä»¶ã€‚\nç‚¹å‡»â€œç¡®å®šâ€å°†è·³è½¬è‡³WPSè¡¨å•é¡µé¢è¿›è¡Œæäº¤ã€‚\n\nè¡¨å•é“¾æ¥ï¼š${formUrl}`);
            if (confirmJump) {
                window.open(formUrl, '_blank');
            }
        });
    </script>
</body>
</html>
